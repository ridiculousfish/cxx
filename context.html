<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Other Rust–C++ interop tools — Rust ♡ C++</title>
        <!-- Custom HTML head -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-DG41MK6DDN"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-DG41MK6DDN', {'anonymize_ip': true});
        </script>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="CXX — safe interop between Rust and C++">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css" disabled="true">
        <link rel="stylesheet" href="ayu-highlight.css" disabled="true">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="css/cxx.css">
    <meta property="og:image" content="https://cxx.rs/cxx.png"><meta property="og:site_name" content="CXX"><meta property="og:title" content="CXX — safe interop between Rust and C++"><meta name="twitter:image:src" content="https://cxx.rs/cxx.png"><meta name="twitter:site" content="@davidtolnay"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="CXX — safe interop between Rust and C++"></head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">var html = document.querySelector('html');
html.classList.remove('no-js');
html.classList.add('js');</script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Rust ❤️ C++</a></li><li class="chapter-item expanded "><a href="concepts.html"><strong aria-hidden="true">2.</strong> Core concepts</a></li><li class="chapter-item expanded "><a href="tutorial.html"><strong aria-hidden="true">3.</strong> Tutorial</a></li><li class="chapter-item expanded "><a href="context.html" class="active"><strong aria-hidden="true">4.</strong> Other Rust–C++ interop tools</a></li><li class="chapter-item expanded "><a href="building.html"><strong aria-hidden="true">5.</strong> Multi-language build system options</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="build/cargo.html"><strong aria-hidden="true">5.1.</strong> Cargo</a></li><li class="chapter-item expanded "><a href="build/bazel.html"><strong aria-hidden="true">5.2.</strong> Bazel</a></li><li class="chapter-item expanded "><a href="build/cmake.html"><strong aria-hidden="true">5.3.</strong> CMake</a></li><li class="chapter-item expanded "><a href="build/other.html"><strong aria-hidden="true">5.4.</strong> More...</a></li></ol></li><li class="chapter-item expanded "><a href="reference.html"><strong aria-hidden="true">6.</strong> Reference: the bridge module</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="extern-rust.html"><strong aria-hidden="true">6.1.</strong> extern &quot;Rust&quot;</a></li><li class="chapter-item expanded "><a href="extern-c++.html"><strong aria-hidden="true">6.2.</strong> extern &quot;C++&quot;</a></li><li class="chapter-item expanded "><a href="shared.html"><strong aria-hidden="true">6.3.</strong> Shared types</a></li><li class="chapter-item expanded "><a href="attributes.html"><strong aria-hidden="true">6.4.</strong> Attributes</a></li><li class="chapter-item expanded "><a href="async.html"><strong aria-hidden="true">6.5.</strong> Async functions</a></li><li class="chapter-item expanded "><a href="binding/result.html"><strong aria-hidden="true">6.6.</strong> Error handling</a></li></ol></li><li class="chapter-item expanded "><a href="bindings.html"><strong aria-hidden="true">7.</strong> Reference: built-in bindings</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="binding/string.html"><strong aria-hidden="true">7.1.</strong> String — rust::String</a></li><li class="chapter-item expanded "><a href="binding/str.html"><strong aria-hidden="true">7.2.</strong> &amp;str — rust::Str</a></li><li class="chapter-item expanded "><a href="binding/slice.html"><strong aria-hidden="true">7.3.</strong> &amp;[T], &amp;mut [T] — rust::Slice&lt;T&gt;</a></li><li class="chapter-item expanded "><a href="binding/cxxstring.html"><strong aria-hidden="true">7.4.</strong> CxxString — std::string</a></li><li class="chapter-item expanded "><a href="binding/box.html"><strong aria-hidden="true">7.5.</strong> Box&lt;T&gt; — rust::Box&lt;T&gt;</a></li><li class="chapter-item expanded "><a href="binding/uniqueptr.html"><strong aria-hidden="true">7.6.</strong> UniquePtr&lt;T&gt; — std::unique_ptr&lt;T&gt;</a></li><li class="chapter-item expanded "><a href="binding/sharedptr.html"><strong aria-hidden="true">7.7.</strong> SharedPtr&lt;T&gt; — std::shared_ptr&lt;T&gt;</a></li><li class="chapter-item expanded "><a href="binding/vec.html"><strong aria-hidden="true">7.8.</strong> Vec&lt;T&gt; — rust::Vec&lt;T&gt;</a></li><li class="chapter-item expanded "><a href="binding/cxxvector.html"><strong aria-hidden="true">7.9.</strong> CxxVector&lt;T&gt; — std::vector&lt;T&gt;</a></li><li class="chapter-item expanded "><a href="binding/rawptr.html"><strong aria-hidden="true">7.10.</strong> *mut T, *const T raw pointers</a></li><li class="chapter-item expanded "><a href="binding/fn.html"><strong aria-hidden="true">7.11.</strong> Function pointers</a></li><li class="chapter-item expanded "><a href="binding/result.html"><strong aria-hidden="true">7.12.</strong> Result&lt;T&gt;</a></li></ol></li><li class="part-title"><a href="https://github.com/dtolnay/cxx"><i class="fa fa-github"></i>https://github.com/dtolnay/cxx</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list" style="display:none">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="https://github.com/dtolnay/cxx" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="context-other-rustc-interop-tools"><a class="header" href="#context-other-rustc-interop-tools">Context: other Rust–C++ interop tools</a></h1>
<p>When it comes to interacting with an idiomatic Rust API or idiomatic C++ API
from the other language, the generally applicable approaches outside of the CXX
crate are:</p>
<ul>
<li>
<p>Build a C-compatible wrapper around the code (expressed using <code class="hljs">extern &quot;C&quot;</code>
signatures, primitives, C-compatible structs, raw pointers). Translate that
manually to equivalent <code class="hljs">extern &quot;C&quot;</code> declarations in the other language and
keep them in sync. Preferably, build a safe/idiomatic wrapper around the
translated <code class="hljs">extern &quot;C&quot;</code> signatures for callers to use.</p>
</li>
<li>
<p>Build a C wrapper around the C++ code and use <strong><a href="https://github.com/rust-lang/rust-bindgen">bindgen</a></strong> to translate that
programmatically to <code class="hljs">extern &quot;C&quot;</code> Rust signatures. Preferably, build a
safe/idiomatic Rust wrapper on top.</p>
</li>
<li>
<p>Build a C-compatible Rust wrapper around the Rust code and use <strong><a href="https://github.com/eqrion/cbindgen">cbindgen</a></strong>
to translate that programmatically to an <code class="hljs">extern &quot;C&quot;</code> C++ header. Preferably,
build an idiomatic C++ wrapper.</p>
</li>
</ul>
<p><strong>If the code you are binding is already <em>&quot;effectively C&quot;</em>, the above has you
covered.</strong> You should use bindgen or cbindgen, or manually translated C
signatures if there aren't too many and they seldom change.</p>
<h2 id="c-vs-c"><a class="header" href="#c-vs-c">C++ vs C</a></h2>
<p>Bindgen has some basic support for C++. It can reason about classes, member
functions, and the layout of templated types. However, everything it does
related to C++ is best-effort only. Bindgen starts from a point of wanting to
generate declarations for everything, so any C++ detail that it hasn't
implemented will cause a crash if you are lucky (<a href="https://github.com/rust-lang/rust-bindgen/issues/388">bindgen#388</a>) or more likely
silently emit an incompatible signature (<a href="https://github.com/rust-lang/rust-bindgen/issues/380">bindgen#380</a>, <a href="https://github.com/rust-lang/rust-bindgen/issues/607">bindgen#607</a>,
<a href="https://github.com/rust-lang/rust-bindgen/issues/652">bindgen#652</a>, <a href="https://github.com/rust-lang/rust-bindgen/issues/778">bindgen#778</a>, <a href="https://github.com/rust-lang/rust-bindgen/issues/1194">bindgen#1194</a>) which will do arbitrary
memory-unsafe things at runtime whenever called.</p>
<p>Thus using bindgen correctly requires not just juggling all your pointers
correctly at the language boundary, but also understanding ABI details and their
workarounds and reliably applying them. For example, the programmer will
discover that their program sometimes segfaults if they call a function that
returns std::unique_ptr&lt;T&gt; through bindgen. Why? Because unique_ptr, despite
being &quot;just a pointer&quot;, has a different ABI than a pointer or a C struct
containing a pointer (<a href="https://github.com/rust-lang/rust-bindgen/issues/778">bindgen#778</a>) and is not directly expressible in Rust.
Bindgen emitted something that <em>looks</em> reasonable and you will have a hell of a
time in gdb working out what went wrong. Eventually people learn to avoid
anything involving a non-trivial copy constructor, destructor, or inheritance,
and instead stick to raw pointers and primitives and trivial structs only
— in other words C.</p>
<h2 id="geometric-intuition-for-why-there-is-so-much-opportunity-for-improvement"><a class="header" href="#geometric-intuition-for-why-there-is-so-much-opportunity-for-improvement">Geometric intuition for why there is so much opportunity for improvement</a></h2>
<p>The CXX project attempts a different approach to C++ FFI.</p>
<p>Imagine Rust and C and C++ as three vertices of a scalene triangle, with length
of the edges being related to similarity of the languages when it comes to
library design.</p>
<p>The most similar pair (the shortest edge) is Rust–C++. These languages
have largely compatible concepts of things like ownership, vectors, strings,
fallibility, etc that translate clearly from signatures in either language to
signatures in the other language.</p>
<p>When we make a binding for an idiomatic C++ API using bindgen, and we fall down
to raw pointers and primitives and trivial structs as described above, what we
are really doing is coding the two longest edges of the triangle: getting from
C++ down to C, and C back up to Rust. The Rust–C edge always involves a
great deal of <code class="hljs">unsafe</code> code, and the C++–C edge similarly requires care
just for basic memory safety. Something as basic as &quot;how do I pass ownership of
a string to the other language?&quot; becomes a strap-yourself-in moment,
particularly for someone not already an expert in one or both sides.</p>
<p>You should think of the <code class="hljs">cxx</code> crate as being the midpoint of the Rust–C++
edge. Rather than coding the two long edges, you will code half the short edge
in Rust and half the short edge in C++, in both cases with the library playing
to the strengths of the Rust type system <em>and</em> the C++ type system to help
assure correctness.</p>
<p>If you've already been through the tutorial in the previous chapter, take a
moment to appreciate that the C++ side <em>really</em> looks like we are just writing
C++ and the Rust side <em>really</em> looks like we are just writing Rust. Anything you
could do wrong in Rust, and almost anything you could reasonably do wrong in
C++, will be caught by the compiler. This highlights that we are on the &quot;short
edge of the triangle&quot;.</p>
<p>But it all still boils down to the same things: it's still FFI from one piece of
native code to another, nothing is getting serialized or allocated or
runtime-checked in between.</p>
<h2 id="role-of-cxx"><a class="header" href="#role-of-cxx">Role of CXX</a></h2>
<p>The role of CXX is to capture the language boundary with more fidelity than what
<code class="hljs">extern &quot;C&quot;</code> is able to represent. You can think of CXX as being a replacement
for <code class="hljs">extern &quot;C&quot;</code> in a sense.</p>
<p>From this perspective, CXX is a lower level tool than the bindgens. Just as
bindgen and cbindgen are built on top of <code class="hljs">extern &quot;C&quot;</code>, it makes sense to think
about higher level tools built on top of CXX. Such a tool might consume a C++
header and/or Rust module (and/or IDL like Thrift) and emit the corresponding
safe cxx::bridge language boundary, leveraging CXX's static analysis and
underlying implementation of that boundary. We are beginning to see this space
explored by the <a href="https://github.com/google/autocxx">autocxx</a> tool, though nothing yet ready for broad use in the
way that CXX on its own is.</p>
<p>But note in other ways CXX is higher level than the bindgens, with rich support
for common standard library types. CXX's types serve as an intuitive vocabulary
for designing a good boundary between components in different languages.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="tutorial.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="building.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="tutorial.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="building.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
